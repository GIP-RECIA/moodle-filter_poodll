define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Filter PoodLL: utils initialising"),{whiteboards:[],whiteboardopts:[],timeouthandles:[],WhiteboardUploadHandler:function(b){var c=a("#"+b+"_btn_upload_whiteboard")[0];c.disabled=!0,clearTimeout(this.timeouthandle),this.CallFileUpload(b)},CallFileUpload:function(c){var d=this.whiteboards[c],e=null,f="";if(0==c.indexOf("drawingboard_")){e=d.canvas;var f=JSON.stringify(d.history,null,2)}else{e=this.whiteboardopts[c].bgimage?d.canvasWithBackground(a("#"+c+"_separate-background-image")[0]):d.getImage({});var f=JSON.stringify(d.getSnapshot())}if(this.whiteboardopts[c].vectorcontrol){var g=a("#"+this.whiteboardopts[c].vectorcontrol);g?g[0].value=f:b.debug("No vector control")}var h=e.toDataURL().split(",")[1],i={type:"image/png"};this.UploadFile(i,h,c)},loadmobileupload:function(a,b){this.gyui=a,this.whiteboardopts[b.recorderid]=b;var c=this.getbyid(b.recorderid+"_poodllfileselect");c&&c.addEventListener("change",function(a){return function(b){M.filter_poodll.FileSelectHandler(b,a)}}(b),!1)},FileSelectHandler:function(a,b){for(var c,d=a.target.files||a.dataTransfer.files,e=0;c=d[e];e++)this.ParseFile(c,b)},ParseFile:function(a,b){var c="",d=new FileReader;d.onloadend=function(d){c=d.target.result,M.filter_poodll.UploadFile(a,c,b.recorderid)},d.readAsDataURL(a)},Output:function(b,c){var d=a("#"+b+"_messages")[0];d.innerHTML=c},getbyid:function(b){var c=a("#"+b);return c&&c.length>0?c[0]:!1},getbyidinparent:function(a){var b=parent.$("#"+a);return b&&b.length>0?b[0]:!1},UploadFile:function(b,c,d){var e=this.whiteboardopts[d],f=new XMLHttpRequest,g="";switch(b.type){case"image/jpeg":g="jpg";break;case"image/png":g="png";break;case"video/quicktime":g="mov";break;case"audio/mpeg3":g="mp3";break;case"audio/x-mpeg-3":g="mp3";break;case"audio/mpeg3":g="mp3";break;case"audio/3gpp":g="3gpp";break;case"video/mpeg3":g="3gpp";break;case"video/mp4":g="mp4"}var h=a("#"+d+"_progress")[0];if(null!=h){var i=h.firstChild;null==i&&(i=h.appendChild(document.createElement("p"))),i.className="",i.style.display="block",i.style.backgroundPosition="100% 0",f.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);i.style.backgroundPosition=b+"% 0"},!1)}else var i=!1;this.Output(d,"Uploading."),f.onreadystatechange=function(a){return function(b){if(4==f.readyState)if(i&&(i.className=200==f.status?"success":"failure"),200==f.status){var c=f.responseText,g=c.indexOf("success<error>");if(1>g)return;var h=c.indexOf("</error>"),j=c.substring(g+14,h);if(e.callbackjs&&""!=e.callbackjs){var k=new Array;k[0]=e.recorderid,k[1]="filesubmitted",k[2]=j,k[3]=e.updatecontrol,a.Output(d,"File saved successfully."),a.executeFunctionByName(e.callbackjs,window,k)}else{a.Output(d,"File saved successfully.");var l=d+"_updatecontrol",m=a.getbyid(l);if(m||(m=a.getbyidinparent(l)),!m)return void a.Output(d,"could not fetch by id: "+l);m=m.value;var n=a.getbyid(m);n||(n=a.getbyidinparent(m)),n?n.value=j:a.Output(d,"File could not be uploaded.")}}else a.Output(d,"File could not be uploaded.")}}(this);var j="datatype=uploadfile";j+="&paramone="+encodeURIComponent(c),j+="&paramtwo="+g,j+="&paramthree="+this.getbyid(d+"_mediatype").value,j+="&requestid="+d,j+="&contextid="+this.getbyid(d+"_contextid").value,j+="&component="+this.getbyid(d+"_component").value,j+="&filearea="+this.getbyid(d+"_filearea").value,j+="&itemid="+this.getbyid(d+"_itemid").value,f.open("POST",this.getbyid(d+"_fileliburl").value,!0),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.setRequestHeader("Cache-Control","no-cache"),f.setRequestHeader("Content-length",j.length),f.setRequestHeader("Connection","close"),f.send(j)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)}}});